# https://taskfile.dev
version: '3'

vars:
  PDF_DIR: ./copyright_compendium_pdfs
  IMAGE_NAME: copyright-compendium

tasks:
  # ── Docker ──────────────────────────────────────────────
  docker:build:
    desc: Build the Docker image for CompendiumUI
    cmds:
      - docker build -t {{.IMAGE_NAME}} ./CompendiumUI

  docker:run:
    desc: Run the CompendiumUI container on port 8080
    deps: [docker:build]
    cmds:
      - docker run --rm -p 8080:80 {{.IMAGE_NAME}}

  # ── Local dev ───────────────────────────────────────────
  dev:
    desc: Start the Vite dev server (hot-reload)
    dir: CompendiumUI
    cmds:
      - npm install
      - npm run dev

  build:
    desc: Build the production bundle
    dir: CompendiumUI
    cmds:
      - npm install
      - npm run build

  preview:
    desc: Preview the production build locally
    dir: CompendiumUI
    cmds:
      - npm run preview

  typecheck:
    desc: Run TypeScript type checking
    dir: CompendiumUI
    cmds:
      - npm install
      - npm run typecheck

  # ── PDF processing ─────────────────────────────────────
  download-pdfs:
    desc: Download Compendium PDFs from copyright.gov
    cmds:
      - python scripts/comp_download.py

  pdf-to-text:
    desc: Extract text from downloaded PDFs into .txt files
    cmds:
      - python scripts/pdf_to_text.py

  process-pdfs:
    desc: Convert PDFs to XHTML using Gemini API
    cmds:
      - python scripts/process_pdfs_gemini.py --directory {{.PDF_DIR}}

  process-pdfs-chunked:
    desc: Convert large PDFs to XHTML in chunks using Gemini API
    cmds:
      - python scripts/process_pdfs_chunked.py --directory {{.PDF_DIR}}

  # ── Tests ─────────────────────────────────────────────
  test:build:
    desc: Build the Python test-runner Docker image
    cmds:
      - docker build -t {{.IMAGE_NAME}}-tests -f tests/Dockerfile tests

  test:unit:
    desc: Run CompendiumUI unit tests (Vitest)
    dir: CompendiumUI
    cmds:
      - npm test

  test:pdf:
    desc: Run PDF↔HTML text comparison on all chapters (in Docker)
    deps: [test:build]
    cmds:
      - docker run --rm -v {{.ROOT_DIR}}:/workspace -e GIT_COMMIT="$(git log -1 --format='%H %s')" {{.IMAGE_NAME}}-tests --algo --report docs/pdf-text-tests.md

  test:chapter:
    desc: Run PDF↔HTML QA on a specific chapter (e.g. task test:chapter -- ch200)
    deps: [test:build]
    cmds:
      - docker run --rm -v {{.ROOT_DIR}}:/workspace {{.IMAGE_NAME}}-tests --algo --chapters {{.CLI_ARGS}}

  test:llm:
    desc: Run LLM-based QA checks (requires GOOGLE_API_KEY)
    deps: [test:build]
    cmds:
      - docker run --rm -v {{.ROOT_DIR}}:/workspace -e GOOGLE_API_KEY {{.IMAGE_NAME}}-tests --llm

  test:all:
    desc: Run all tests (unit + PDF text comparison)
    cmds:
      - task: test:unit
      - task: test:pdf

  # ── Documentation ───────────────────────────────────
  docs:serve:
    desc: Serve documentation locally with mkdocs
    cmds:
      - mkdocs serve

  docs:build:
    desc: Build documentation with mkdocs
    cmds:
      - mkdocs build

  docs:docker:build:
    desc: Build the Docker image for documentation
    cmds:
      - docker build -f Dockerfile.docs -t {{.IMAGE_NAME}}-docs .

  docs:docker:run:
    desc: Run the documentation container on port 8000
    deps: [docs:docker:build]
    cmds:
      - docker run --rm -p 8000:8000 {{.IMAGE_NAME}}-docs
